{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NQ1MYQTHLM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-NQ1MYQTHLM');
  </script>
  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "gezh5n3gqv");
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4467857259742793"
    crossorigin="anonymous"></script>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="{% static 'main_page/favicon.ico' %}">
  <title>The best Sonic OC generator </title>
  <style>
    body {
      background-color: #2fa5e9;
    }

    ::selection {
      background-color: #fcbe14; /* Change this color to your desired selection background color */
      color: #000; /* Change this color to your desired selected text color */
    }

    ::-moz-selection {
      background-color: #fcbe14; /* Change this color to your desired selection background color */
      color: #000; /* Change this color to your desired selected text color */
    }

    .content-container {
      display: flex;
      align-items: flex-start;
      flex-wrap: wrap;
      padding-top: 3%;
    }

    .small-image {
      width: 100%;
      height: 100%;
    }

    /* Grid where images are */
    .image-grid {
      /* Centers instructions in image grid */
      justify-content: center;
      align-items: center;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      margin-left: 20%;

      height: 768px;
      width: 512px;
      box-sizing: border-box;
      border: 1px solid #3880ec;
      border-radius: 10px;
      background-color: #3880ec;
      position: relative;

      /* Keeps image edges from going outside image-grid */
      overflow: hidden;

      /* Stops gap between images */
      border: 0;
    }

    #loading-container {
      position: relative;
      top: 50%;
      left: 50%;
      text-align: center;
      z-index: 1;
    }

    #queue-position {
      opacity: 70%;
    }

    #instructions {
      position: relative;
      top: 50%;
      left: 50%;
      text-align: center;
      z-index: 1;
      opacity: 70%;
    }

    .expanded-image {
      grid-column: 1 / -1;
      grid-row: 1 / -1;
      z-index: 10;
      transition: all 0.5s ease-in-out;
      object-fit: cover;
    }

    /* Includes prompt input box, generate button and advanced options */
    .input-button-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      width: 5in;
      padding-left: 10px;
    }

    /* Includes prompt input box and generate button */
    #prompt-input-box {
      align-items: flex-start;
      justify-content: top;
      padding-left: 10px;
      padding-bottom: 10px;
    }

    /* The input box itself where text is */
    #prompt-input {
      height: 5vh;
    }

    #denoise-strength {
      display: none;
    }

    #enable-inpainting {
      display: none;
    }

    #advanced-options {
      padding-left: 10px;
      z-index: 1;
      width: 5in;
    }

    .card {
      background-color: #3880ec;
      border: 0;
    }

    .card-body {
      background-color: #2fa5e9;
    }

    #close-button {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      padding: 10px;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      object-fit: none;
    }

    #error-modal {
      display: none;
    }

    @media (max-width: 480px) {
      .content-container {
        flex-direction: column;
        padding: 0%;
      }

      .image-grid {
        width: 100vw;
        height: 150vw;
        max-width: max-content;
        max-height: max-content;
        aspect-ratio: 1 / 1;
        margin-left: 0%;
        margin-right: 0%;
        border: 0;
      }

      .input-button-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        width: 100vw;
        flex-grow: 1;
        padding-left: 0;
        padding-bottom: 5%;
        height: auto;
      }

      #prompt-input-box {
        padding-bottom: 5%;
        padding-left: 0;
      }

      #prompt-input {
        height: 6vh;
      }

      #denoise-strength {
        padding: 2vw;
        width: 100vw;
      }

      #enable-inpainting {
        display: none;
      }

      #advanced-options {
        width: 97vw;
      }

      .FAQ {
        padding: 0vw;
        width: 95vw;
      }

      .row {
        width: 100vw;
      }

      .card-body {
        padding-right: 0;
        padding-left: 0;
        padding-bottom: 0;
      }

      .mb-0 {
        padding-left: 2vw;
        padding-right: 2vw;
      }
    }
  </style>
</head>

<body>
  <div class="modal" tabindex="-1" id="error-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">API Error</h5>
        </div>
        <div class="modal-body">
          <p>There was an API error, if using a reference image, refresh the page and try using a different one.
          <p></p>If not, refresh or check back later, backend may be down</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Image box for generations -->
  <div class="content-container">
    <div class="image-grid" ondragover="allowDrop(event)" ondrop="handleDrop(event)">
      <!-- Upload images -->
      <input type="file" name="image" id="image-upload" accept="image/*" style="display: none;">

      <!-- close button -->
      <button type="button" class="btn-close" aria-label="Close" id="close-button"
        onclick="collapseImage('close-button')"></button>

      <!-- Canvas for inpainting -->
      <canvas id="drawing-canvas" width="510" height="768" style="display: none; position: fixed; z-index: 200;"></canvas>


      <!-- Prompt instructions -->
      <div id="instructions">Type a prompt and hit generate to start! Or click/tap here to add an image to use as a
        reference!</div>

      <!-- Loading container -->
      <div id="loading-container" class="d-none">
        <!-- Loading bar -->
        <div id="loading-bar">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generating images...</span>
          </div>
          <!-- Loading text -->
          <div id="queue-position"></div>
        </div>
      </div>

      <!-- Images -->
      <img id="img-top-left" src="" class="small-image" alt="Image goes here" onerror="this.style.display='none'"
        onclick="expandImage('img-top-left', 'close-button')">
      <img id="img-top-right" src="" class="small-image" alt="Image goes here" onerror="this.style.display='none'"
        onclick="expandImage('img-top-right', 'close-button')">
      <img id="img-bottom-left" src="" class="small-image" alt="Image goes here" onerror="this.style.display='none'"
        onclick="expandImage('img-bottom-left', 'close-button')">
      <img id="img-bottom-right" src="" class="small-image" alt="Image goes here" onerror="this.style.display='none'"
        onclick="expandImage('img-bottom-right', 'close-button')">
    </div>

    <!-- Prompt input box and advanced options button -->
    <div class="input-button-container">
      <div id="prompt-input-box" class="input-group d-flex align-items-stretch">
        <textarea class="form-control" placeholder="Enter Prompt" aria-label="Enter Prompt"
          aria-describedby="button-addon2" id="prompt-input" rows="3"></textarea>
        <button class="btn btn-primary d-flex align-items-center" type="button" id="button-addon2">Generate!</button>
      </div>

      <!-- Denoise strength -->
      <div id="denoise-strength">
        <label for="custom-denoise" class="form-label">Strength: <span id="denoise-value">0.7</span>
          <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Adjust how much the source image should be followed. Lower values will follow the reference image more closely, higher values will change the image more. A value of 1 will ignore the reference image entirely."
            style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
            ?
          </span>
        </label>
        <input type="range" class="form-range" min="0.1" max="0.95" value="0.7" step="0.05" id="custom-denoise">
      </div>

      <!-- inpaint switch -->
      <div class="form-check form-switch" id="enable-inpainting">
        <input class="form-check-input" type="checkbox" id="flexSwitchCheckDefault" onclick="enableInpaintCanvas()">
        <label class="form-check-label" for="flexSwitchCheckDefault">Inpaint</label>
        <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top"
          title="Allows you to draw on the image you uploaded using your mouse to specify what should be changed. The inpainted areas will be the only ones changed while the rest of the image is unaffected"
          style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
          ?
        </span>
      </div>

      <!-- Advanced options -->
      <div id="advanced-options">
        <button class="btn btn-primary dropdown-toggle" data-bs-toggle="collapse" href="#collapseExample" role="button"
          aria-expanded="false" aria-controls="collapseExample">
          Advanced Options
        </button>
        <div class="collapse w-100" id="collapseExample">
          <label for="floatingSelect">Image aspect-ratio</label>
          <select class="form-select" id="floatingSelect" aria-label="Floating label select example"
            onchange="changeAspectRatio()">
            <option value="3">Portrait</option>
            <option value="1">Landscape</option>
            <!-- <option value="2">Square</option> -->
          </select>

          <div class="card card-body">
            <!-- Negative Prompt -->
            <div class="mb-3">
              <label for="negative-prompt-input" class="form-label">Negative Prompt
                <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top"
                  title="Add terms you want the AI to avoid when generating the image. Separate each term with a comma. By default a negative prompt is provided so this does not need to be modifed unless the below negative does not work well for you."
                  style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
                  ?
                </span>
              </label>
              <textarea class="form-control" id="negative-prompt-input" rows="3"
                placeholder="nsfw, worst quality, low quality, simple background, bad anatomy, bad hands, deformed limbs, blurry, cropped, cross-eyed, extra arms, extra digit, extra fingers, extra legs, extra limbs, extra digit, bad proportions, missing fingers, missing legs, poorly drawn hands, signature, text, bad feet, watermark, flat background">nsfw, worst quality, low quality, simple background, bad anatomy, bad hands, deformed limbs, blurry, cropped, cross-eyed, extra arms, extra digit, extra fingers, extra legs, extra limbs, extra digit, bad proportions, missing fingers, missing legs, poorly drawn hands, signature, text, bad feet, watermark, flat background</textarea>
            </div>


            <!-- Seed -->
            <div class="mb-3">
              <label for="seedInput" class="form-label">Seed
                <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top"
                  title="Each generated image has a specific seed, if that seed is entered with the same prompt, 
                you can regenerate the same or very similar images. By default a random seed is used with each generation."
                  style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
                  ?
                </span>
              </label>
              <input type="text" class="form-control" id="seedInput" placeholder="-1">
            </div>

            <!-- CFG -->
            <label for="customRange1" class="form-label">CFG: <span id="cfg-value">7</span>
              <span class="ms-1 text-primary" data-bs-toggle="tooltip" data-bs-placement="top"
                title="CFG refers to how closely a image tries follow to a prompt, too high values may fry 
                images, while too low of a value will result in an unrelated photo being generated. By default 7 is used but this can be experimented with."
                style="background-color: rgba(255, 255, 255, 0.8); padding: 2px 4px; border-radius: 50%; cursor: pointer;">
                ?
              </span>
            </label>
            <input type="range" class="form-range" min="2" max="15" value="7" id="customRange1">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAQ Section -->
  <div class="container">
    <div class="FAQ">
      <div class="row">
        <div class="col-md-12 ">
          <h2 class="mb-4">FAQ</h2>
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                What are some tips for good images?
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-0">Make sure to include their full name when generating
                for best results! EX: Sonic -> 'Sonic the hedgehog', Tails -> 'Tails the fox'.
              <p></p>
              The model was trained on booru tags, using them allows your images to turn out better and be more
              specific. If you
              would like to turn an existing image into booru tags to input into the model,
              use the following website: <a
                href="https://huggingface.co/spaces/SmilingWolf/wd-v1-4-tags">https://huggingface.co/spaces/SmilingWolf/wd-v1-4-tags</a>
              and copy the output into the prompt.
              </p>
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-header">
              <h5 class="mb-0">
                What characters can I generate?
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-0">Curent list is as follows.
                <div class="row">
                  <div class="col col-md-4">
                    <ul>
                      <li>Amy Rose</li>
                      <li>Big the cat</li>
                      <li>Blaze the cat</li>
                      <li>Bunnie Rabbot</li>
                      <li>Charmy the bee</li>
                      <li>Cosmo the seedrian</li>
                      <li>Cream the rabbit</li>
                      <li>Espio the chameleon</li>
                      <li>Honey the cat</li>
                      <li>Jet the hawk</li>
                      <li>Knuckles the echidna</li>
                    </ul>
                  </div>
                  <div class="col col-md-4">
                    <ul>
                      <li>Lanolin the sheep</li>
                      <li>Marine the Raccoon</li>
                      <li>Metal Sonic</li>
                      <li>Mighty the armadillo</li>
                      <li>Mina Mongoose</li>
                      <li>Mobian (Original characters in sonic style basically!)</li>
                      <li>Nicole the Lynx</li>
                      <li>Rouge the bat</li>
                      <li>Sally Acorn</li>
                      <li>Shadow the hedgehog</li>
                      <li>Silver the hedgehog</li>
                    </ul>
                  </div>
                  <div class="col col-md-4">
                    <ul>
                      <li>Sonic the hedgehog</li>
                      <li>Sticks the badger</li>
                      <li>Storm the albatross</li>
                      <li>Surge the tenrec</li>
                      <li>Tails the fox</li>
                      <li>Tangle the lemur</li>
                      <li>Tikal the echidna</li>
                      <li>Vanilla the rabbit</li>
                      <li>Vector the crocodile</li>
                      <li>Wave the swallow</li>
                      <li>Whisper the wolf</li>
                    </ul>
                  </div>
                </div>
              </p>
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-header">
              <h5 class="mb-0">
                Can I run this locally on my PC?
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-0">Yep! Model is available to use in stable diffusion here <a
                  href="https://civitai.com/models/1493">https://civitai.com/models/1493</a></p>
            </div>
          </div>
          <div class="card mt-3">
            <div class="card-header">
              <h5 class="mb-0">
                About
              </h5>
            </div>
            <div class="card-body">
              <p class="mb-0">Hi there! I'm a big fan of AI and Sonic, so I thought why not combine the two? As someone
                who never
                had the mind to express themselves artistically, AI art has opened up a whole new world for me and I'd
                like to be able to share that openly for every sonic fan to express themselves!

              <p>
              <p></p>
              <p class="mb-0">
                I'm hoping to be able to keep this site up as long as I'm financially able to, but as the site grows
                more popular it will be hard to keep up with GPU demand and server cost,
                so any support is greatly appreciated!
              </p>
              <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js"
                data-name="bmc-button" data-slug="pablocastr6" data-color="#5F7FFF" data-emoji="" data-font="Cookie"
                data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#ffffff"
                data-coffee-color="#FFDD00"></script>

                Join the discord for model updates, share images, and chat! Special thanks to "Mecha from the '80s" and "RinMaru" for helping gather training images!</p>

              <iframe src="https://discord.com/widget?id=1095514548112461924&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
            </div>
          </div>
          <!-- Add more questions and answers as needed -->
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Set mode
    let mode = 'txt2img';

    // This is the JavaScript code for the image upload
    const imageGrid = document.querySelector(".image-grid");
    const imageInput = document.getElementById("image-upload");

    function handleImageGridClick() {
      imageInput.click();
    }

    function handleImageInputChange() {
      if (imageInput.files.length === 0) {
        return;
      }
      handleImageSelect({ target: { files: imageInput.files } });
    }


    imageGrid.addEventListener("click", handleImageGridClick);

    imageInput.addEventListener("change", handleImageInputChange);

    function allowDrop(event) {
      event.preventDefault();
    }

    function drop(event) {
      event.preventDefault();
      if (event.dataTransfer.items) {
        for (let i = 0; i < event.dataTransfer.items.length; i++) {
          if (event.dataTransfer.items[i].kind === "file") {
            const imageFile = event.dataTransfer.items[i].getAsFile();
            handleImageSelect({ target: { files: [imageFile] } });
          }
        }
      } else {
        for (let i = 0; i < event.dataTransfer.files.length; i++) {
          handleImageSelect({ target: { files: [event.dataTransfer.files[i]] } });
        }
      }
    }

    var base64Str;
    function handleImageSelect(event) {
      const closeButton = document.getElementById("close-button");
      const denoiseStrength = document.getElementById("denoise-strength");
      const inpaint = document.getElementById("enable-inpainting");
      const imageFile = event.target.files[0];

      if (imageFile) {
        const reader = new FileReader();
        reader.onload = function (e) {
          // Set the image source to the data URL
          document.getElementById("img-top-left").src = e.target.result;

          // UI stuff
          document.getElementById("instructions").classList.add("d-none");
          expandImage("img-top-left", "close-button")
          document.getElementById('img-top-left').style.width = '100%';
          document.getElementById('img-top-left').style.height = 'auto';
          document.getElementById('img-top-left').style.display = 'block';

          closeButton.style.display = "none";
          denoiseStrength.style.display = 'block';

          // Dont show inpainting for mobile devices
          if (!isMobileDevice()) {
            inpaint.style.display = 'block';
          }

          // Get the base64 string from the data URL
          base64Str = e.target.result.split(",")[1];
          mode = 'img2img';
        };
        reader.readAsDataURL(imageFile);
      }
    }

    // inpainting 
    const canvas = document.getElementById("drawing-canvas");
    const ctx = canvas.getContext("2d");
    ctx.lineWidth = 40; // Increase the value for a larger drawn area
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    let drawing = false;

    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
    });

    canvas.addEventListener("mousemove", (e) => {
      if (!drawing) return;
      ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
      ctx.stroke();
    });

    canvas.addEventListener("mouseup", () => {
      drawing = false;
    });

    function enableDrawing() {
      canvas.style.display = "block";
    }

    function disableDrawing() {
      canvas.style.display = "none";
    }

    function getDrawingBase64() {
      ctx.globalCompositeOperation = "destination-over";
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.globalCompositeOperation = "source-over";
      return canvas.toDataURL().split(",")[1];
    }

    let inpainting = false;
    const enableInpaintCanvas = () => {
      inpainting = !inpainting;
      if (inpainting) {
        mode = 'inpainting';
        const imageGrid = document.querySelector('.image-grid');

        imageGrid.removeEventListener("click", handleImageGridClick);
        enableDrawing();
        document.getElementById("drawing-canvas").style.display = "block";
        document.getElementById("denoise-strength").style.display = "none";
      }
      else {
        mode = 'img2img';

        imageGrid.addEventListener("click", handleImageGridClick);
        disableDrawing()
        document.getElementById("drawing-canvas").style.display = "none";
        document.getElementById("denoise-strength").style.display = "block";
      }
    };

    // Check if user is using mobile device
    function isMobileDevice() {
      return (
        typeof window.orientation !== "undefined" ||
        navigator.userAgent.indexOf("IEMobile") !== -1
      );
    }

    // Info buttons
    document.addEventListener('DOMContentLoaded', function () {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })
    })

    // Expand image on click
    let expanded = false;
    let currentImage = null;
    let expanded_image_id = null;

    function expandImage(imageId, closeButtonId) {
      if (expanded) return;
      expanded = true;

      // Hide all except selected image
      switch (imageId) {
        case 'img-top-left':
          document.getElementById('img-top-right').style.display = 'none';
          document.getElementById('img-bottom-left').style.display = 'none';
          document.getElementById('img-bottom-right').style.display = 'none';
          break;

        case 'img-top-right':
          document.getElementById('img-top-left').style.display = 'none';
          document.getElementById('img-bottom-left').style.display = 'none';
          document.getElementById('img-bottom-right').style.display = 'none';
          break;

        case 'img-bottom-left':
          document.getElementById('img-top-left').style.display = 'none';
          document.getElementById('img-top-right').style.display = 'none';
          document.getElementById('img-bottom-right').style.display = 'none';
          break;

        case 'img-bottom-right':
          document.getElementById('img-top-left').style.display = 'none';
          document.getElementById('img-top-right').style.display = 'none';
          document.getElementById('img-bottom-left').style.display = 'none';
          break;
      }

      expanded_image_id = imageId;
      const image = document.getElementById(imageId);
      const closeButton = document.getElementById(closeButtonId);

      image.classList.add('expanded-image');
      closeButton.style.display = 'block';

      currentImage = image;

      // Set the width and height of the expanded image to match the container depending on if on mobile or not
      if (window.innerWidth < 480) {
        image.style.width = '100vw';
        image.style.height = 'auto%';
      } else {
        image.style.width = 'auto';
        image.style.height = 'auto';
      }

    }

    function collapseImage(closeButtonId) {
      if (!expanded) return;
      expanded = false;

      const image = document.getElementById(expanded_image_id);
      const closeButton = document.getElementById(closeButtonId);

      image.classList.remove('expanded-image');
      closeButton.style.display = 'none';

      // Reset the width and height of the collapsed image
      currentImage.style.width = '';
      currentImage.style.height = '';

      resetAllImageDisplays();
    }

    // Allows us to see the images that are generated
    const resetImageDisplay = (imageId) => {
      const imageElement = document.getElementById(imageId);
      imageElement.style.display = 'block';
    };

    // Unhide all images
    const resetAllImageDisplays = () => {
      resetImageDisplay('img-top-left');
      resetImageDisplay('img-top-right');
      resetImageDisplay('img-bottom-left');
      resetImageDisplay('img-bottom-right');
    };

    // Hide all images
    const hideAllImages = () => {
      document.getElementById('img-top-left').style.display = 'none';
      document.getElementById('img-top-right').style.display = 'none';
      document.getElementById('img-bottom-left').style.display = 'none';
      document.getElementById('img-bottom-right').style.display = 'none';
    };

    // update image box ratio
    const changeAspectRatio = () => {
      const selectElement = document.getElementById('floatingSelect');
      const selectedOption = selectElement.options[selectElement.selectedIndex].value;
      const imageGrid = document.querySelector('.image-grid');
      let isMobileView = window.matchMedia('(max-width: 1200px)').matches;

      switch (selectedOption) {
        case '1':
          // Landscape
          if (isMobileView) {
            imageGrid.style.width = '100vw';
            imageGrid.style.height = '66vw';
            imageGrid.style.aspectRatio = '2/1';
          } else {
            imageGrid.style.width = '691px';
            imageGrid.style.height = '460px';
          }
          break;
        case '2':
          // Square
          if (isMobileView) {
            imageGrid.style.width = '100vw';
            imageGrid.style.height = '100vw';
          } else {
            imageGrid.style.width = '512px';
            imageGrid.style.height = '512px';
          }
          break;
        case '3':
          // Portrait
          if (isMobileView) {
            imageGrid.style.width = '100vw';
            imageGrid.style.height = '150vw';
          } else {
            imageGrid.style.width = '512px';
            imageGrid.style.height = '768px';
          }
          break;
        default:
          if (isMobileView) {
            imageGrid.style.width = '1024px';
            imageGrid.style.height = '1536px';
          } else {
            imageGrid.style.width = '512px';
            imageGrid.style.height = '768px';
          }
      }

      hideAllImages();
    };

    // Dynamic changing of CFG and denoise sliders when moved
    document.getElementById('customRange1').addEventListener('input', function (event) {
      document.getElementById('cfg-value').textContent = event.target.value;
    });
    document.getElementById('denoise-strength').addEventListener('input', function (event) {
      document.getElementById('denoise-value').textContent = event.target.value;
    });

    // Send the request to the server for generated images
    document.getElementById('button-addon2').addEventListener('click', async function () {
      // Disable the generate button until result is returned
      document.getElementById('button-addon2').disabled = true;

      // Hide images
      hideAllImages();

      // Hide close-image button if it was on
      document.getElementById("close-button").style.display = 'none';

      // Hide inpainting canvas if it was on
      document.getElementById("drawing-canvas").style.display = "none";

      // Show loading bar
      document.getElementById("instructions").classList.add("d-none");
      document.getElementById("loading-container").classList.remove("d-none");
      // Fetch user's position in the queue periodically
      document.getElementById("queue-position").innerText = `Generating Image... Please wait`;

      // Remove the event listeners
      imageGrid.removeEventListener("click", handleImageGridClick);
      imageInput.removeEventListener("change", handleImageInputChange);

      // Set the width and height of the expanded image to match the container
      let imageWidth;
      let imageHeight;
      let model;

      const selectElement = document.getElementById('floatingSelect');
      const selectedOption = selectElement.options[selectElement.selectedIndex].value;
      switch (selectedOption) {
        case '1':
          imageWidth = 768; // Landscape
          imageHeight = 512;
          model = "SonicDiffusionV3-Delta__768x512x4"
          break;
        case '2':
          imageWidth = 512;
          imageHeight = 512; // Square
          model = "Metal079--SonicDiffusionV3-Beta__512x512x4"
          break;
        case '3':
          imageWidth = 512; // Portrait
          imageHeight = 768;
          model = "SonicDiffusionV3-Delta__512x768x4"
          break;
        default:
          imageWidth = 512;
          imageHeight = 768;
          model = "SonicDiffusionV3-Delta__512x768x4"
      }

      let payload;
      let response;

      let drawingBase64;
      if (mode == 'inpainting') {
        drawingBase64 = getDrawingBase64();
      }

      switch (mode) {
        case 'txt2img':
          payload = {
            "data": {
              "prompt": document.getElementById('prompt-input').value,
              "steps": 20,
              "negative_prompt": document.getElementById('negative-prompt-input').value,
              "seed": Number(document.getElementById('seedInput').value) || Math.floor(Math.random() * 999999),
              "guidance_scale": Number(document.getElementById('customRange1').value) || 7,
              "batch_size": 4,
              "width": imageWidth || 512,
              "height": imageHeight || 768,
              "scheduler": 7
            },
            "model": model,
            "save_image": false,
          }

          // Call Volta API
          response = await fetch('txt2img/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          break;

        case 'img2img':
          payload = {
            "data": {
              "prompt": document.getElementById('prompt-input').value,
              "image": base64Str,
              "steps": 30,
              "negative_prompt": document.getElementById('negative-prompt-input').value,
              "seed": Number(document.getElementById('seedInput').value) || Math.floor(Math.random() * 999999),
              "guidance_scale": Number(document.getElementById('customRange1').value) || 7,
              "batch_size": 4,
              "width": imageWidth || 512,
              "height": imageHeight || 768,
              "scheduler": 13,
              "strength": document.getElementById('custom-denoise').value || 0.7
            },
            "model": model,
            "save_image": false,
          }

          // Call Volta API
          response = await fetch('img2img/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          break;

        case 'inpainting':
          payload = {
            "data": {
              "prompt": document.getElementById('prompt-input').value,
              "image": base64Str,
              "mask_image": drawingBase64,
              "scheduler": 7,
              "negative_prompt": document.getElementById('negative-prompt-input').value,
              "width": imageWidth || 512,
              "height": imageHeight || 768,
              "steps": 40,
              "guidance_scale": Number(document.getElementById('customRange1').value) || 7,
              "seed": Number(document.getElementById('seedInput').value) || Math.floor(Math.random() * 999999),
              "batch_size": 4,
              "strength": 1
            },
            "model": "SonicDiffusionV3-Delta",
          }

          // Call Volta API
          response = await fetch('inpainting/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });
          break;
      }

      // Set back to txt2img mode
      mode = 'txt2img';
      const denoiseStrength = document.getElementById("denoise-strength");
      const inpaint = document.getElementById("enable-inpainting");
      denoiseStrength.style.display = 'none';
      inpaint.style.display = 'none';

      // Handle the API response
      if (response.ok) {
        const data = await response.json(); // Parse the JSON response
        const base64Images = data.images;
        const closeButton = document.getElementById("close-button");

        // When the image is retrieved, hide the loading bar and queue
        document.getElementById("loading-container").classList.add("d-none");

        // Set the src attribute of the image elements to the base64-encoded images
        document.getElementById('img-top-left').src = 'data:image/png;base64,' + base64Images[0];
        document.getElementById('img-top-right').src = 'data:image/png;base64,' + base64Images[1];
        document.getElementById('img-bottom-left').src = 'data:image/png;base64,' + base64Images[2];
        document.getElementById('img-bottom-right').src = 'data:image/png;base64,' + base64Images[3];

        // Unhide the images and enable generate button
        collapseImage("img-top-left", "close-button")
        resetAllImageDisplays();
        document.getElementById('button-addon2').disabled = false;
      } else {
        console.error(`Error: ${response.status}`); // Handle the error
        const error_modal = document.getElementById("error-modal");
        error_modal.style.display = 'block'
      }
    });

  </script>
</body>

</html>